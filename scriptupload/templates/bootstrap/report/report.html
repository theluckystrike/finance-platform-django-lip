{% extends 'bootstrap/base.html' %}
{% load static %}
{% load render_table from django_tables2 %}
{% block content %}
<script src="https://unpkg.com/htmx.org@1.9.10"
    integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
    crossorigin="anonymous"></script>
<script src="{% static 'bootstrap/path-params.js' %}"></script>
<style>
    .tree-container * {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .tree-container ul li {
        margin-left: 20px;
        position: relative;
        padding-left: 10px;
        line-height: 1.5;
        font-size: 16px;
        /* Adjust font size as needed */
    }

    .tree-container ul li::before {
        content: " ";
        position: absolute;
        width: 1px;
        background-color: #000;
        top: 5px;
        bottom: -15px;
        left: -15px;
    }

    .tree-container body>ul>li:first-child::before {
        top: 15px;
    }

    .tree-container ul li:not(:first-child):last-child::before {
        display: none;
    }

    .tree-container ul li:only-child::before {
        display: list-item;
        content: " ";
        position: absolute;
        width: 1px;
        background-color: #000;
        top: 5px;
        bottom: 10px;
        height: 10px;
        left: -15px;
    }

    .tree-container ul li::after {
        content: " ";
        position: absolute;
        left: -15px;
        width: 15px;
        height: 1px;
        background-color: #000;
        top: 15px;
    }
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{report.name}}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if report.status == 'running' %}
        <div class="mx-2 my-1">
            <div class="spinner-border" role="status"></div>
        </div>
        {% endif %}
        {% if report.latest_pdf %}
        <a href="{{ report.latest_pdf.url }}" class="btn btn-sm btn-outline-secondary my-1">View latest&nbsp;<span
                class="align-text-bottom" data-feather="eye"></span></a>
        {% endif %}
        <form method="post" action="{% url 'update_report' report.id %}">
            {% csrf_token %}
            <button type="submit"
                class="btn btn-sm btn-outline-success my-1 mx-2 {% if report.status == 'running' %} disabled {% endif %}">Update&nbsp;<span
                    class="align-text-bottom" data-feather="play"></span></button>
        </form>
        <form method="post" action="{% url 'delete_report' report.id %}">
            {% csrf_token %}
            <button type="submit"
                class="btn btn-sm btn-outline-danger my-1 {% if report.status == 'running' %} disabled {% endif %}">Delete&nbsp;<span
                    class="align-text-bottom" data-feather="file-minus"></span></button>
        </form>
    </div>
</div>
<div class="row mb-5">
    <div class="mt-3 col-12 col-md-6 col-sm-12">
        <h4>Scheduled emails</h4>
        All reports are sent at 12:00 PM UTC
        <div class="table-responsive">
            {% if scripts %}
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th scope="col">Email</th>
                        <th scope="col">Schedule</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <th scope="row">{{task.email}}</th>
                        <td>Every {{ days_of_week|get_item:task.day }}</td>
                        <td>
                            <form method="post" action="{% url 'delete_task' task.id %}">
                                {% csrf_token %}
                                <button class="text-danger text-decoration-none">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    <form method="post">
                        {% csrf_token %}

                        <tr>
                            <th><input type="text" placeholder="email@example.com" name="email"></th>
                            <th><select class="lead" name="day">
                                    <option value="1">Every Monday</option>
                                    <option value="2">Every Tuesday</option>
                                    <option value="3">Every Wednesday</option>
                                    <option value="4">Every Thursday</option>
                                    <option value="5">Every Friday</option>
                                    <option value="6">Every Saturday</option>
                                    <option value="7">Every Sunday</option>
                                    <option value="*">Every day</option>
                                </select></th>
                            <th><button class="text-decoration-none text-primary">Add</button></th>
                        </tr>
                    </form>
                </tbody>
            </table>
            {% else %}
            <span class="text-large">
                No scheduled tasks
            </span>
            {% endif %}
        </div>
        <div hx-get="add-script/{scriptid}/" hx-swap="none" hx-ext="path-params" hx-include="[name='scriptid']"
            class="row mt-5">
            <h4>Add script</h4>
            <div class="col-9">

                <select class="form-select" name="scriptid">
                    <option value="" disabled selected>Select a script</option>
                    {% for cat in categories %}
                    <optgroup label="{{cat.name}}">
                        {% for subcat in cat.category_set.all %}
                    <optgroup label="&nbsp;&nbsp;&nbsp;&nbsp;{{subcat.name}}">
                        {% for subsubcat in subcat.category_set.all %}
                    <optgroup label="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{subsubcat.name}}">
                        {% for script in subsubcat.script_set.all %}
                        {% if script not in report.scripts.all %}
                        <option value="{{script.id}}">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{script.name}}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                    </optgroup>
                    {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div class="col-3 text-center">
                <button class="btn btn-sm btn-outline-primary text-primary h-100 w-75">Add</button>
            </div>
        </div>
    </div>
    <div class="mt-3 col-12 col-md-6 col-sm-12 tree-container">
        <h4 class="pb-4">Scripts in this report</h4>
        {% render_table report_scripts_table %}
    </div>
</div>
<div class="text-muted">
    <b>Created:</b> {{report.created}} &ensp; <b>Last run:</b> {{report.last_updated}}
</div>
<script>
    var status = "{{report.status}}"
    if (status == "running") {
        pollReport()
    }
    function pollReport() {
        var intervalId = setInterval(function () {
            $.ajax({
                url: "{% url 'report_status' reportid=report.id %}",
                type: 'GET',
                success: function (response) {
                    if (response.status === 'success') {
                        clearInterval(intervalId);
                        window.location.reload()
                    } else if (response.status == "failure") {
                        clearInterval(intervalId);
                        window.location.reload()
                    }
                },
                error: function () {
                    console.error('Error in request');
                }
            });
        }, 5000);
    }
</script>
{% endblock %}